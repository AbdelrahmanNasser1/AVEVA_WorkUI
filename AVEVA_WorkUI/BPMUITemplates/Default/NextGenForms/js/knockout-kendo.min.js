/*!
 * knockout-kendo 0.10.0
 * Copyright © 2017 Ryan Niemeyer & Telerik
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 * 
 * Modifications done from the original version:
 * - Added support for custom functionality useKoTemplates for the kendoGrid control.
 * - Added code to set the default value for the kendoColor control as #1b1b1b.
 * - Commented out the code in the extendAndRedraw method where value assignment is 
 *   done by adding 0.001, as the KendoRadialGauge control does a completed redraw when 
 *   there is no value change.
 * - Corrected min and max methods for the kendoNumericTextbox
 * - Added readOnly bindings for the below controls:
 *   - kendoDatePicker
 *   - kendoDateTimePicker
 *   - kendoEditor
 *   - kendoNumericTextBox
 *   - kendoTimePicker
 * - Kept the bindings for below Kendo controls only, rest all are commented, as only 
 *   below Kendo conrols are being used by our product:
 *   - kendoCalendar
 *   - kendoColorPicker
 *   - kendoDatePicker
 *   - kendoDateTimePicker
 *   - kendoEditor
 *   - kendoGrid
 *   - kendoNumericTextBox
 *   - kendoTimePicker
 *   - kendoTreeView
 *   - kendoRadialGauge
 *   - kendoDropDownTree
 */
(function(n){typeof require=="function"&&typeof exports=="object"&&typeof module=="object"?n(require("knockout"),require("jquery"),require("kendo")):typeof define=="function"&&define.amd?define(["knockout","jquery","kendo"],n):n(window.ko,window.jQuery,window.kendo)})(function(n,t,i,r){var s;i=i||window.kendo;n.kendo=n.kendo||{};s=n.utils.unwrapObservable;n.kendo.BindingFactory=function(){var u=this,f;this.createBinding=function(f){if(t()[f.parent||f.name]){var e={};e.init=function(n,t,i,r,o){var s=u.buildOptions(f,t);if(s.async===!0||f.async===!0&&s.async!==!1){setTimeout(function(){e.setup(n,s,o)},0);return}return e.setup(n,s,o),s&&s.useKOTemplates?{controlsDescendantBindings:!0}:void 0};e.setup=function(e,o,s){var h,c=t(e);u.setupTemplates(f.templates,o,e,s);o.useKOTemplates===!0&&o.data!==r&&(o.dataSource=o.data);h=u.getWidget(f,o,c);u.handleEvents(o,f,e,h,s);u.watchValues(h,o,f,e);h.destroy&&n.utils.domNodeDisposal.addDisposeCallback(e,function(){h.element&&(typeof i.destroy=="function"?i.destroy(h.element):h.destroy())})};e.options={};e.widgetConfig=f;n.bindingHandlers[f.bindingName||f.name]=e}};this.buildOptions=function(t,r){var f=t.defaultOption,e=n.utils.extend({},n.bindingHandlers[t.name].options),u=s(r());return u instanceof i.data.DataSource||typeof u!="object"||u===null||f&&!(f in u)?e[f]=r():n.utils.extend(e,u),e};f=function(t,i){return function(r){return n.renderTemplate(t,i.createChildContext(r._raw&&r._raw()||r))}};this.setupTemplates=function(t,i,r,u){var e,h,o,s;if(t&&i&&i.useKOTemplates){for(e=0,h=t.length;e<h;e++)o=t[e],i[o]&&(i[o]=f(i[o],u));s=i.dataBound;i.dataBound=function(){n.memoization.unmemoizeDomNodeAndDescendants(r);s&&s.apply(this,arguments)}}};this.unwrapOneLevel=function(n){var t,r={};if(n)if(n instanceof i.data.DataSource)r=n;else if(typeof n=="object")for(t in n)r[t]=s(n[t]);return r};this.getWidget=function(t,i,r){var u,f;return t.parent?(f=r.closest("[data-bind*='"+t.parent+":']"),u=f.length?f.data(t.parent):null):u=r[t.name](this.unwrapOneLevel(i)).data(t.name),n.isObservable(i.widget)&&i.widget(u),u};this.watchValues=function(n,t,i,r){var f,e=i.watch;if(e)for(f in e)e.hasOwnProperty(f)&&u.watchOneValue(f,n,t,i,r)};this.watchOneValue=function(i,u,f,e,o){var h=n.computed({read:function(){var a,l,n=e.watch[i],h=s(f[i]),c=e.parent?[o]:[];t.isArray(n)?n=u[h?n[0]:n[1]]:typeof n=="string"?n=u[n]:l=!0;n&&f[i]!==r&&(l?c.push(h,f):(a=n.apply(u,c),e.name!=="kendoColorPicker"||i!=="value"||h||(h="#1b1b1b"),c.push(h)),(l||a!==h)&&n.apply(u,c))},disposeWhenNodeIsRemoved:o}).extend({throttle:f.throttle||f.throttle===0?f.throttle:1});n.isObservable(f[i])||h.dispose()};this.handleEvents=function(n,t,i,r,f){var o,e,s=t.events;if(s)for(o in s)s.hasOwnProperty(o)&&(e=s[o],typeof e=="string"&&(e={value:e,writeTo:e}),u.handleOneEvent(o,e,n,i,r,t.childProp,f))};this.handleOneEvent=function(t,i,r,u,f,e,o){var s=typeof i=="function"?i:r[i.call];typeof i=="function"?s=s.bind(o.$data,r):i.call&&typeof r[i.call]=="function"?s=r[i.call].bind(o.$data,o.$data):i.writeTo&&n.isWriteableObservable(r[i.writeTo])&&(s=function(n){var t,f;e&&n[e]&&n[e]!==u||(t=i.value,f=typeof t=="string"&&this[t]?this[t](e&&u):t,r[i.writeTo](f))});s&&f.bind(t,s)}};n.kendo.bindingFactory=new n.kendo.BindingFactory;n.kendo.setDataSource=function(t,r,u){var f,e;if(r instanceof i.data.DataSource){t.setDataSource(r);return}u&&u.useKOTemplates||(f=n.mapping&&r&&r.__ko_mapping__,e=r&&f?n.mapping.toJS(r):n.toJS(r));t.dataSource.data(e||r)},function(){var n=i.data.ObservableArray.fn.wrap;i.data.ObservableArray.fn.wrap=function(t){if(t!==null){var i=n.apply(this,arguments);return i._raw=function(){return t},i}}}();var a=function(t){return function(i){i&&(n.utils.extend(this.options[t],i),this.redraw())}},p=function(n,i){n?this.open(typeof i.target=="string"?t(s(i.target)):i.target):this.element.parent().is(":visible")&&this.close()},f=n.kendo.bindingFactory.createBinding.bind(n.kendo.bindingFactory),v="close",e="enable",o="isOpen",c="max",l="min",y="open",h="readonly",u="value";f({name:"kendoCalendar",defaultOption:u,events:{change:u},watch:{max:c,min:l,value:u}});f({name:"kendoColorPicker",events:{change:u,open:{writeTo:o,value:!0},close:{writeTo:o,value:!1}},watch:{enabled:e,value:u,color:u,palette:"palette"}});f({name:"kendoDatePicker",defaultOption:u,events:{change:u,open:{writeTo:o,value:!0},close:{writeTo:o,value:!1}},watch:{readOnly:h,enabled:e,max:c,min:l,value:u,isOpen:[y,v]}});f({name:"kendoDateTimePicker",defaultOption:u,events:{change:u,open:{writeTo:o,value:!0},close:{writeTo:o,value:!1}},watch:{readOnly:h,enabled:e,max:c,min:l,value:u,isOpen:[y,v]}});f({name:"kendoEditor",defaultOption:u,events:{change:u},watch:{readOnly:h,enabled:e,value:u}});f({name:"kendoGrid",defaultOption:"data",watch:{data:function(t,i){n.kendo.setDataSource(this,t,i)}},templates:["rowTemplate","altRowTemplate"]});f({name:"kendoNumericTextBox",defaultOption:u,events:{change:u,spin:u},watch:{readOnly:h,enabled:e,value:u,max:function(n){this.options.max=n},min:function(n){this.options.min=n}}});f({name:"kendoTimePicker",defaultOption:u,events:{change:u},watch:{readOnly:h,max:c,min:l,value:u,enabled:e,isOpen:[y,v]}});f({name:"kendoTreeView",watch:{data:function(t,i){n.kendo.setDataSource(this,t,i)}},events:{change:function(t,i){if(n.isWriteableObservable(t.value)){var r=i.sender;t.value(r.dataItem(r.select()))}}},async:!0});f({name:"kendoDropDownTree",events:{change:u},watch:{data:function(t,i){n.kendo.setDataSource(this,t,i)},value:u},templates:["valueTemplate","template"]});f({name:"kendoRadialGauge",defaultOption:u,watch:{value:u,gaugeArea:a("gaugeArea"),pointer:a("pointer"),scale:a("scale")}})})