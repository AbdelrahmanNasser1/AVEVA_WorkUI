var WGServiceEngine={PrepareCommand:function(d,c,a,b){var g=false;var h=null;var f=c;if(!h){h=d.RootTable}d.LastClientAction=f;switch(c){case"Refresh":c="ClientService_Select";a="Refresh";break;case"BatchUpdate":c="ClientService_BatchUpdate";a="";break;case"ColumnSort":case"ColumnFilter":case"PagingNext":case"PagingPrev":case"PagingTo":var i=0;if(c=="PagingNext"){if(d.CurrentPageIndex<d.TotalPages){i=d.CurrentPageIndex+1}else{return false}}else{if(c=="PagingPrev"){if(d.CurrentPageIndex-1>0){i=d.CurrentPageIndex-1}else{return false}}else{if(c=="PagingTo"){i=b}}}if(c.indexOf("Paging")>-1){if(i>d.TotalPages){return false}else{if(d.CurrentPageIndex==i){return false}else{d.CurrentPageIndex=i}}}if(d.IsClientOperation()){d.RebindData();g=true;if(c=="ColumnFilter"||c.indexOf("Paging")>-1){WGBindingEngine.PostDataBound(h,true)}}else{if(c=="ColumnFilter"){d.CurrentPageIndex=1}c="ClientService_Select";a="Refresh"}break;case"Group":case"Ungroup":case"ChangeGroup":case"ColumnChange":if(c=="Group"||c=="Ungroup"){WGBindingEngine.SynchronizeTemplate(h.HtmlTemplate,c,[1,b])}if(d.IsClientOperation()){d.RebindData();g=true}else{c="ClientService_Select";a="Refresh"}break;case"More":if(d.TotalLoadedRows==d.TotalRows||d.LastAction=="Insert"){return false}if(d.IsClientOperation()){var e=WGBindingEngine._PopulateRows(h,h.GetView(),null,d.TotalLoadedRows);WGBindingEngine.MergeGridRows(h.Rows,e);WGBindingEngine.AddLoadedRows(h,e);g=true}else{c="ClientService_Select";a="More"}break;case"LoadGroup":if(!d.IsClientOperation()){c="ClientService_Select";a="LoadGroup"}break}if(!g){WGServiceEngine.ExecuteCommand(d,c,a,b,f)}},ExecuteCommand:function(p,l,a,b,y){if(l.indexOf("ClientService")==-1){throw new Error("Invalid client service command.")}var t=b;var z=null;var x=p.ClientBindingSettings;var c=[];var m=new DataSourceSelectArguments();var r=x.DataSourceType=="AdoDataService";if(!z){z=p.RootTable}l=l.replace("ClientService_","");switch(l){case"Select":switch(a){case"LoadData":case"Refresh":case"More":m.OperationType="SelectData";break;case"ValueList":m.OperationType="SelectValueList";m.ViewName=t.DataMember;break;case"SelectCount":m.OperationType="SelectCount";break}if(a!="Refresh"){y=a}if(a!="ValueList"){var o=true;var A=false;if(a=="More"){m.StartRowIndex=p.TotalLoadedRows;m.MaximumRows=m.StartRowIndex+p.LayoutSettings.VirtualPageSize;o=false}else{if(a=="LoadGroup"){A=true;m.OperationType="SelectData"}else{if(m.OperationType=="SelectData"&&z.GroupedColumns.length>0){if(p.LayoutSettings.PagingMode=="VirtualLoad"&&!p.IsClientOperation()){m.OperationType="SelectGroup";if(p.ClientBindingSettings.PreloadGroupTotals){m.CalculateAggregates=true;m.AggregatesExpression=[];for(var q=0;q<z.Columns.length;q++){var k=z.Columns[q];if(k.AggregateFunction!="None"){var n=new Object();n.Member=k.DataMember;n.expression=k.AggregateFunction;m.AggregatesExpression.push(n)}}}}}}}z.FillDataSourceArguments(m,true,true,o,A,b)}if(p.ClientBindingSettings.DataSourceType=="AdoDataService"){if(m.ViewName==""){throw new Error("ViewName can't be empty. Please specify the table name to the DataMember property of WebGridTable.")}}p.SetStatus1("","loadingdata","CommonText/LoadingDataClient");p.ClientProvider.ExecuteSelect(m);break;case"Update":if(x.ItemTypeName==""){throw new Error("ItemTypeName is required for add new row operation.")}var w=t;var u=w.DataRow.ObjectContext;var s=ISDataEngine.BuildObject(x.ItemTypeName,r);if(r){z.FillDataSourceArguments(m);s=new Object();if(u.__metadata){s.__metadata=u.__metadata}}w.CopyTo(s,r);c[0]=s;p.LastRequestObj=w;p.SetStatus1("","updaterow","CommonText/UpdateRow");p.ClientProvider.ExecuteUpdate(s,u,m);break;case"Insert":if(x.ItemTypeName==""){throw new Error("ItemTypeName is required for add new row operation.")}var w=t;var s=ISDataEngine.BuildObject(x.ItemTypeName,r);if(r){z.FillDataSourceArguments(m)}w.CopyTo(s,false,true);c[0]=s;p.LastRequestObj=w;p.SetStatus1("","addrow","CommonText/AddRow");p.ClientProvider.ExecuteInsert(s,m);break;case"Delete":var w=t;var u=w.DataRow.ObjectContext;c[0]=u;p.SetStatus1("","deleterow","CommonText/DeleteRow");p.ClientProvider.ExecuteDelete(u);break;case"BatchUpdate":var h=new Array();var v=p.GetChanges();var f=new Array();if(r){z.FillDataSourceArguments(m)}for(var q=0;q<v.length;q++){var g=v[q];var j=new ClientRowChanges();var d=null;if(x.ItemTypeName==""){throw new Error("ItemTypeName is required for add new row operation.")}if(g.RowState=="Added"){var w=g.Row;var s=ISDataEngine.BuildObject(x.ItemTypeName,r);w.CopyTo(s,false,true);j.NewObject=s;d=[s,m]}else{if(g.RowState=="Modified"){var w=g.Row;var u=w.DataRow.ObjectContext;var s=ISDataEngine.BuildObject(x.ItemTypeName,r);if(r){s=new Object();if(u.__metadata){s.__metadata=u.__metadata}}if(s.__type){u.__type=s.__type}w.CopyTo(s,r);j.OriginalObject=u;j.NewObject=s;d=[s,u,m]}else{if(g.RowState=="Deleted"){j.OriginalObject=g.Row.DataRow.ObjectContext;d=[j.OriginalObject,m]}}}j.RowState=g.RowState;j.TableName=g.Table.Name;h.push(j);if(r){var e=new AstoriaBatchChanges();if(g.RowState=="Added"){e.Command="Insert"}else{if(g.RowState=="Modified"){e.Command="Update"}else{if(g.RowState=="Deleted"){e.Command="Delete"}}}e.Arguments=d;f.push(e)}}p.SetStatus1("","batchupdate","CommonText/BatchUpdate");p.ClientProvider.ExecuteBatchUpdate(r?f:h);break}p.IsInProgress=true;p.SetBusy();p.LastAction=l;p.ClientProvider.LastCommand=[l,a,b,z,c,y,m]},PostResponse:function(a){a.IsInProgress=false;WG50Engine.ReflectNoDataStatus(a);a.LastAction="";a.LastClientAction="";a.LastRequestObj=null;a.TempLRO=null;a.IsUnhandledError=false;a.IsStatusLocked=false;a.SetStatus1("","ready","CommonText/Ready");a.SetIdle()},OnResponse:function(m,v){if(!v){WGUIEngine.DisplayErrorBox(m,"NetworkException: WebGrid receives no response from web service.",m.GetString("MessageBoxText/UnhandledError"));return}var z=v;if(typeof(v.d)!="undefined"){v=v.d}if(typeof(v.Results)!="undefined"){v=v.Results}var y=m.ClientProvider;var q=y.LastCommand;var f=q[0];var a=q[1];var w=q[2];var D=q[3];var c=q[4];var C=q[5];var i=q[6];var B=m.ClientBindingSettings;var p=B.DataSourceType=="AdoDataService";if(!D){D=m.RootTable}if(y.IsBatchUpdateProgress){y.ExecuteBatchUpdate(y.BatchQueues);return}switch(f){case"Select":switch(a){case"LoadData":case"Refresh":if(i.OperationType=="SelectGroup"){var j=D.DispatchDataTable();if(j==null){j=D.CreateDataTable()}j.Rows.Clear();D.Rows=null;D.DefaultView=null;WGBindingEngine.EnsureDataBound(D,j,[v.Children]);m.Render()}else{m.RebindData(v)}if(C=="ColumnFilter"||C=="LoadData"||C=="Refresh"){if(typeof(z.TotalRowCount)=="number"){m.SetTotalRows(z.TotalRowCount)}else{if(m.IsClientBinding("ClientService")&&!m.IsClientOperation()){setTimeout(function(){WGServiceEngine.ExecuteCommand(m,"ClientService_Select","SelectCount")},10)}}}break;case"ValueList":WGServiceEngine.PopulateDropDownList(w.Parent,v);break;case"SelectCount":if(typeof(v)!="number"){throw new Error("SelectCount implementation is required for PagedData loading mode.")}m.TotalRows=v;WGBindingEngine.PostDataBound(D,true);break;case"More":var h=ISDataEngine.GetDataSet(v);if(h!=null&&h.Tables){var k=h.Tables[0].GetDefaultView();var r=WGBindingEngine._PopulateRows(D,k,null,m.TotalLoadedRows);ISDataEngine.MergeDataTable(h.Tables[0],D.DispatchDataTable());WGBindingEngine.MergeGridRows(D.Rows,r);WGBindingEngine.AddLoadedRows(D,r)}break;case"LoadGroup":var h=ISDataEngine.GetDataSet(v);if(h!=null&&h.Tables){var k=h.Tables[0].GetDefaultView();var j=D.DispatchDataTable();var E=D.ToRowObject(w);var r=WGBindingEngine.EnsureDataBound(D,k,[null,false,[E.Position,E.GetGroupRowLevel()]]);WGGroupingEngine.AddLoadedGroupRows(D,r[0])}break}break;case"Update":if(v.Exception!=null){if(!v.ExceptionHandled){WGUIEngine.DisplayErrorBox(m,v.Exception.Message,m.GetString("MessageBoxText/UnhandledError"))}WG50Engine.HandleCommonError(m);WGEventEngine.SelectRow(w.GetElement(),m.GetCurSelImage())}else{var g=w.DataRow;var s=c[0];ISDataEngine.AttachObject(g,s);WGEditEngine.AcceptChanges(w.GetElement())}break;case"Insert":if(v.Exception!=null){if(!v.ExceptionHandled){WGUIEngine.DisplayErrorBox(m,v.Exception.Message,m.GetString("MessageBoxText/UnhandledError"))}WG50Engine.HandleCommonError(m)}else{var A=w;var s=c[0];var j=D.DispatchDataTable()==null?D.CreateDataTable():D.DispatchDataTable();var t=j.NewRow();var k=D.GetView();if(p){s=v}ISDataEngine.AttachObject(t,s);j.Rows.Add(t);if(v.NewID&&D.GetPrimaryKey()!=""){s[D.GetPrimaryKey()]=v.NewID;var d=t.Cells.GetNamedItem(D.GetPrimaryKey());if(d!=null){d.Value=v.NewID}}if(k!=null){ISDataViewEngine.CreateDataViewRow(k,t)}if(D.GroupedColumns.length>0){m.RebindData()}else{var b=true;if(m.LayoutSettings.PagingMode=="VirtualLoad"&&m.TotalLoadedRows<m.TotalRows){b=false}if(b){var n=WGBindingEngine.CreateRow(D,t,j.Rows.length-1);D.AddRow(n,true)}}var u=m.LastRequestObj;try{if(u.RowElement){WGEditEngine.InitializeNewRow(m,u.RowElement);if(m.LastSelObj.GetRowElement().type=="NewRow"){WGEventEngine.SelectRow(u.RowElement,m.GetCurSelImage())}}}catch(l){}}break;case"Delete":var A=w;var x=c[0];D.RemoveRow(A,null,true);break;case"BatchUpdate":m.ClearChanges();ISEvent.Raise(m.LayoutSettings.ClientSideEvents.OnBatchUpdateSuccess,m.Id,false,null);setTimeout(function(){m.Refresh()},10);break}if(f!="Select"){WGBindingEngine.PostDataBound(D,true)}WGServiceEngine.PostResponse(m)},PopulateDropDownList:function(a,d){var b=document.getElementById(a.Table.Grid.Id+"_"+a.Table.Name+"_"+a.Name);var f=a.ValueList;if(b!=null){b.remove(0);for(var c=0;c<d.length;c++){var e=document.createElement("option");e.text=d[c][f.DataTextField];e.value=d[c][f.DataValueField];b.options.add(e)}if(typeof(b.desiredValue)!="undefined"){b.value=b.desiredValue}else{b.value=null}}f.DataRetrieved=true}};